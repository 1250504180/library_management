<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title data-i18n="bookRecommendation">图书推荐</title>
    <link href="../../javaex/pc/css/common.css" rel="stylesheet" />
    <link href="../../javaex/pc/css/skin/tina.css" rel="stylesheet" />
    <script src="../../javaex/pc/lib/jquery-1.7.2.min.js"></script>
    <script src="../../javaex/pc/js/javaex.min.js"></script>
    <script src="/lang/lang.js"></script>
    <style>
        body {
            background-color: #f5f6fa;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        }
        .recommendation-box {
            width: 90%;
            margin: 40px auto;
            padding: 30px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            text-align: center;
        }
        .recommendation-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        .recommendation-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #e0e0e0;
            table-layout: fixed;
            margin: 0 auto;
        }
        .recommendation-table th, .recommendation-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            word-wrap: break-word;
            word-break: break-all;
            vertical-align: top;
        }
        .recommendation-table th {
            background-color: #ecf0f1;
            color: #34495e;
            font-weight: bold;
        }
        .recommendation-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .recommendation-table tr:hover {
            background-color: #f1f1f1;
        }
        .recommendation-table td:nth-child(1) {
            width: 20%;
        }
        .recommendation-table td:nth-child(2) {
            width: 15%;
        }
        .recommendation-table td:nth-child(3) {
            width: 65%;
        }
        .page {
            text-align: center;
            margin-top: 20px;
        }
        .pagination li {
            display: inline-block;
            margin: 0 5px;
            padding: 6px 12px;
            background-color: #eaeaea;
            border-radius: 4px;
            cursor: pointer;
        }
        .pagination li.active {
            background-color: #3498db;
            color: white;
        }
    </style>
</head>
<body>
<div class="recommendation-box">
    <div class="recommendation-title" data-i18n="bookRecommendation">图书推荐</div>
    <table class="recommendation-table">
        <thead>
        <tr>
            <th data-i18n="bookName">书籍名称</th>
            <th data-i18n="recommendMonth">推荐月份</th>
            <th data-i18n="recommendReason">推荐理由</th>
        </tr>
        </thead>
        <tbody id="recommendation-tbody"></tbody>
    </table>
    <div class="page">
        <ul id="pagination" class="pagination"></ul>
    </div>
</div>

<script>
    function getQueryParam(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
    }

    const lang = getQueryParam("lang") || localStorage.getItem("lang") || "zh";

    let pageSize = 10;
    let currentPage = 1;

    function loadRecommendations(page = 1) {
        $.ajax({
            type: "GET",
            url: "/api/recommendation/search",
            data: { page: page, size: pageSize },
            success: function(result) {
                if (result.code !== 0) {
                    $("#recommendation-tbody").html("<tr><td colspan='3'>" + (result.msg || i18n[lang].loadFailed || "加载失败") + "</td></tr>");
                    return;
                }
                const data = result.data || {};
                const records = data.records || [];
                let html = "";
                records.forEach(rec => {
                    html += `<tr>
                        <td>${rec.bookName || ''}</td>
                        <td>${rec.recommendMonth || ''}</td>
                        <td>${rec.recommendReason || ''}</td>
                    </tr>`;
                });
                if (html === "") {
                    html = "<tr><td colspan='3'>" + i18n[lang].noData + "</td></tr>";
                }
                $("#recommendation-tbody").html(html);

                renderPage(data.total || 0, data.current || 1, data.size || pageSize);
            },
            error: function() {
                $("#recommendation-tbody").html("<tr><td colspan='3'>" + i18n[lang].dataLoadFailed + "</td></tr>");
            }
        });
    }

    function renderPage(total, curr, size) {
        const totalPage = Math.ceil(total / size);
        const $pagination = $("#pagination");
        $pagination.empty();

        for (let i = 1; i <= totalPage; i++) {
            const li = $(`<li>${i}</li>`);
            if (i === curr) {
                li.addClass("active");
            }
            li.click(function() {
                currentPage = i;
                loadRecommendations(currentPage);
            });
            $pagination.append(li);
        }
    }

    $(document).ready(function() {
        loadLang(lang);           // ✅ 翻译在 DOM 完成后执行
        loadRecommendations();    // ✅ 数据加载
    });
</script>
</body>
</html>